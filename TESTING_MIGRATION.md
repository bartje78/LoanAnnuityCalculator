# Testing the Balance Sheet Migration

## Step 1: Verify the table was created

The migration successfully created the `BalanceSheetLineItems` table. We confirmed this by running:
```bash
sqlite3 loans.db "SELECT COUNT(*) FROM BalanceSheetLineItems;"
# Result: 0 (table exists but is empty)
```

## Step 2: Start the backend

Make sure the backend is running on port 5206.

## Step 3: Trigger the migration

You have 3 options:

### Option A: Browser (Easiest for testing)
Open your browser and navigate to:
```
http://localhost:5206/api/debtor/4/migrate-balance-sheet
```

You should see a JSON response like:
```json
{
  "Message": "Successfully migrated 1 balance sheet(s) for debtor 4",
  "DebtorId": 4,
  "MigratedCount": 1
}
```

### Option B: Curl command
```bash
curl -X POST http://localhost:5206/api/debtor/4/migrate-balance-sheet
```

### Option C: Frontend Button (We'll implement this)
We can add a button to the frontend UI to trigger migration.

## Step 4: Verify the data was migrated

After running the migration, check the database:

```bash
cd "/Users/bartkoolhaas/Visual Studio Projecten/LoanAnnuityCalculator/LoanAnnuityCalculatorAPI"

# Count total line items
sqlite3 loans.db "SELECT COUNT(*) FROM BalanceSheetLineItems;"

# View all line items
sqlite3 loans.db "SELECT Id, Category, Label, Amount, IsAutoGenerated FROM BalanceSheetLineItems;"

# View line items grouped by category
sqlite3 loans.db "
SELECT 
    Category, 
    COUNT(*) as Count, 
    SUM(Amount) as Total,
    SUM(CASE WHEN IsAutoGenerated = 1 THEN 1 ELSE 0 END) as AutoGenerated
FROM BalanceSheetLineItems 
GROUP BY Category;
"
```

## Step 5: Test the new API endpoint

Once migrated, test the new detailed balance sheet endpoint:

```bash
curl http://localhost:5206/api/debtor/4/balance-sheet-details | python3 -m json.tool
```

This should return the balance sheet with all line items, including:
- Current Assets from uploaded balance sheet
- Fixed Assets (collateral properties)
- Current Liabilities from uploaded balance sheet  
- Long-Term Liabilities (tracked loans)
- Any manual "other" liabilities

## Expected Result for Debtor 4

Based on the data we saw earlier:
- **Current Assets**: €236,407 (manual from upload)
- **Fixed Assets**: €1,840,000 (collateral - property)
- **Current Liabilities**: €14,454 (manual from upload)
- **Long-Term Liabilities**: 
  - Loan #6: ~€225,000
  - Loan #7: ~€1,768,245
  - Other: €165,751 (difference between uploaded total and tracked loans)

**Total**: Should balance to OwnersEquity = -€97,043

## Troubleshooting

If the migration endpoint returns an error or doesn't work:

1. Check backend logs for errors
2. Verify debtor 4 exists in the database
3. Check that balance sheets exist for debtor 4:
   ```bash
   sqlite3 loans.db "SELECT * FROM DebtorBalanceSheets WHERE DebtorID = 4;"
   ```
4. Check that loans exist for debtor 4:
   ```bash
   sqlite3 loans.db "SELECT Id, LoanAmount, AnnualInterestRate FROM Loans WHERE DebtorID = 4;"
   ```

## Next Steps

After successful migration:
1. Update Monte Carlo frontend to use the new simplified endpoint
2. Add a "Refresh Balance Sheet" button to the UI
3. Implement automatic refresh when loans or collateral change
